(()=>{"use strict";var e=document.querySelector(".page"),t=e.querySelector(".profile"),n=t.querySelector(".profile__user-name"),o=t.querySelector(".profile__user-description"),r=t.querySelector(".profile__image"),u=e.querySelector(".gallery__items"),i="97490d78-0aeb-4bf4-9e55-1aeead76a69d",a="users/me",c="cards";function s(e,t){e.textContent=t}function l(e){return"https://nomoreparties.co/v1/plus-cohort-14/"+e}function d(){return fetch(l(a),{method:"GET",headers:{authorization:i}}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))}var f=e.querySelector("#popup_profile_edit"),p=e.querySelector(".profile__button-edit"),_=f.querySelector(".popup__button-close"),m=document.forms.user_info,v=document.forms.user_info.user_name,y=document.forms.user_info.user_description,h=document.forms.user_info.user_submit,b=e.querySelector("#popup_img_add"),S=e.querySelector(".profile__button-add"),g=b.querySelector(".popup__button-close"),E=document.forms.place_info,C=document.forms.place_info.place_name,L=document.forms.place_info.place_link,k=document.forms.place_info.place_submit,q=e.querySelector("#popup_img_preview"),j=q.querySelector(".popup__button-close"),P=q.querySelector(".popup__image"),T=q.querySelector(".popup__item-info"),w=e.querySelector("#popup_confirm_delete"),x=w.querySelector(".popup__button-close"),B=(w.querySelector(".popup__button-save"),e.querySelector("#popup_avatar_edit")),z=e.querySelector(".profile__avatar"),A=B.querySelector(".popup__button-close"),D=document.forms.user_avatar,I=document.forms.user_avatar.avatar_link,N=document.forms.user_avatar.avatar_save;function O(e){e.classList.add("popup_opened"),document.addEventListener("keydown",G)}function J(e){e.classList.remove("popup_opened"),document.removeEventListener("keydown",G)}function M(e){e.classList.contains("popup")&&J(e)}function G(e){e.key&&"Escape"===e.key&&J(document.querySelector(".popup_opened"))}function H(e,t){e.value=t,e.dispatchEvent(new Event("input",{bobbles:!0}))}function V(e,t){t.textContent=e.value}function U(e){var t=u.querySelector("#gallery_template").content.querySelector(".gallery__item").cloneNode(!0),n=t.querySelector(".gallery__image");n.src=e.link,n.alt=e.name,n.addEventListener("click",(function(){var t,n,o,r,u;t=P,n=e.link,o=e.name,t.src=n,t.alt=o,r=T,u=e.name,r.textContent=u,O(q)})),t.querySelector(".gallery__item-name").textContent=e.name;var o=t.querySelector(".gallery__button-like"),r=t.querySelector(".gallery__like-counter");e.likes.some((function(t){return t._id==e.userId}))?o.classList.add("gallery__button-like_active"):o.classList.remove("gallery__button-like_active"),r.textContent=e.likes.length,o.addEventListener("click",(function(){var t=o.classList.contains("gallery__button-like_active");(function(e,t){var n=t?"PUT":"DELETE";return fetch(l("cards/likes")+"/"+e,{method:n,headers:{authorization:i}}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))})(e._id,!t).then((function(e){r.textContent=String(e.likes.length),o.classList.toggle("gallery__button-like_active")})).catch((function(){return console.log("Запрос изменения состояния лайка не удался")}))}));var a=t.querySelector(".gallery__button-delete");return e.owner._id!==e.userId?a.remove():a.addEventListener("click",(function(){var n;(n=e._id,fetch(l(c)+"/"+n,{method:"DELETE",headers:{authorization:i}}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))).catch((function(){return console.log("Запрос удаление карточки не удался")})),t.remove()})),t}function F(e,t){t.prepend(e)}function K(e,t){return e.querySelector(".".concat(t.name,"-error"))}function Q(e,t,n,o){t.validity.patternMismatch?t.setCustomValidity(t.dataset.errorMessage):t.setCustomValidity(""),t.validity.valid?function(e,t,n,o){var r=K(e,t);t.classList.remove(n),r.classList.remove(o),r.textContent=""}(e,t,n,o):function(e,t,n,o,r){var u=K(e,t);t.classList.add(o),u.textContent=n,u.classList.add(r)}(e,t,t.validationMessage,n,o)}function R(e,t,n){!function(e){return e.some((function(e){return!e.validity.valid}))}(e)?(t.classList.remove(n),t.removeAttribute("disabled")):(t.classList.add(n),t.setAttribute("disabled",!0))}function W(e){var t,n,o=document.querySelector(e.formSelector);t={form:o,inputs:Array.from(o.querySelectorAll(e.inputSelector)),button:o.querySelector(e.submitButtonSelector)},n={buttonClass:e.inactiveButtonClass,inputClass:e.inputErrorClass,errorClass:e.errorClass},t.form.addEventListener("submit",(function(e){return e.preventDefault()})),R(t.inputs,t.button,n.buttonClass),t.inputs.forEach((function(e){Q(t.form,e,n.inputClass,n.errorClass),e.addEventListener("input",(function(){Q(t.form,e,n.inputClass,n.errorClass),R(t.inputs,t.button,n.buttonClass)}))}))}p.addEventListener("click",(function(){d().then((function(e){H(v,e.name),H(y,e.about),s(h,"Сохранить"),O(f)})).catch((function(){return console.log("Запрос получения информации о пользователе удался")}))})),_.addEventListener("click",(function(){J(f)})),m.addEventListener("submit",(function(e){e.preventDefault();var t="";s(h,"Сохранение..."),function(e,t){return fetch(l(a),{method:"PATCH",headers:{authorization:i,"Content-Type":"application/json"},body:JSON.stringify({name:e,about:t})}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))}(v.value,y.value).then((function(){V(v,n),V(y,o),t="Сохранено"})).catch((function(){t="Ошибка",console.log("Запрос на сохранение информации о пользователе не удался")})).finally((function(){s(h,t),J(f)}))})),f.addEventListener("mousedown",(function(e){M(e.target)})),S.addEventListener("click",(function(){H(C,""),H(L,""),s(k,"Сохранить"),O(b)})),g.addEventListener("click",(function(){J(b)})),E.addEventListener("submit",(function(e){e.preventDefault();var t,n,o="";s(k,"Сохранение..."),(t=C.value,n=L.value,fetch(l(c),{method:"POST",headers:{authorization:i,"Content-Type":"application/json"},body:JSON.stringify({name:t,link:n})}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))).then((function(e){d().then((function(t){e.userId=t._id,F(U(e),u),o="Сохранено"})).catch((function(){return console.log("Запрос получения информации о пользователе удался")}))})).catch((function(){o="Ошибка",console.log("Запрос на создание карточки не удался")})).finally((function(){s(k,o),J(b)}))})),b.addEventListener("mousedown",(function(e){M(e.target)})),j.addEventListener("click",(function(){J(q)})),q.addEventListener("mousedown",(function(e){M(e.target)})),x.addEventListener("click",(function(e){J(w)})),w.addEventListener("mousedown",(function(e){M(e.target)})),z.addEventListener("click",(function(){d().then((function(e){H(I,e.avatar),s(N,"Сохранить"),O(B)})).catch((function(){return console.log("Запрос получения информации о пользователе удался")}))})),A.addEventListener("click",(function(){J(B)})),D.addEventListener("submit",(function(e){e.preventDefault();var t,n="";s(N,"Сохраненине..."),(t=I.value,fetch(l("users/me/avatar"),{method:"PATCH",headers:{authorization:i,"Content-Type":"application/json"},body:JSON.stringify({avatar:t})}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))).then((function(e){r.src=e.avatar,n="Сохранено"})).catch((function(){n="Ошибка",console.log("Запрос на отправку аватара пользователя не удался")})).finally((function(){s(N,n),J(B)}))})),B.addEventListener("mousedown",(function(e){M(e.target)})),d().then((function(e){n.textContent=e.name,o.textContent=e.about,r.setAttribute("src",e.avatar)})).catch((function(){return console.log("Запрос получения информации о пользователе удался")})),fetch(l(c),{method:"GET",headers:{authorization:i}}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))})).then((function(e){d().then((function(t){(e=e.reverse()).forEach((function(e){e.userId=t._id,F(U(e),u)}))})).catch((function(){return console.log("Запрос получения информации о пользователе удался")}))})).catch((function(){return console.log("Запрос получения массива карточек не удался")})),W({formSelector:"#user_info",inputSelector:".form__input",submitButtonSelector:".popup__button-save",inactiveButtonClass:"popup__button-save_disabled",inputErrorClass:"form__input_error",errorClass:"form__input-error-msg_visible"}),W({formSelector:"#place_info",inputSelector:".form__input",submitButtonSelector:".popup__button-save",inactiveButtonClass:"popup__button-save_disabled",inputErrorClass:"form__input_error",errorClass:"form__input-error-msg_visible"}),W({formSelector:"#user_avatar",inputSelector:".form__input",submitButtonSelector:".popup__button-save",inactiveButtonClass:"popup__button-save_disabled",inputErrorClass:"form__input_error",errorClass:"form__input-error-msg_visible"})})();