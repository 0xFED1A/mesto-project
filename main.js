(()=>{"use strict";function e(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}var t=document.querySelector(".page"),n=t.querySelector(".profile"),r=n.querySelector(".profile__user-name"),o=n.querySelector(".profile__user-description"),i=n.querySelector(".profile__image"),u=t.querySelector(".gallery__items"),a={baseUrl:"https://nomoreparties.co/v1/plus-cohort-14/",headers:{authorization:"97490d78-0aeb-4bf4-9e55-1aeead76a69d","Content-Type":"application/json"}},s="users/me",c="cards",l=fetch(a.baseUrl+s,{method:"GET",headers:a.headers}).then((function(t){return e(t)})),d=fetch(a.baseUrl+c,{method:"GET",headers:a.headers}).then((function(t){return e(t)}));function f(e,t){e.textContent=t}var _=t.querySelector("#popup_profile_edit"),p=t.querySelector(".profile__button-edit"),m=_.querySelector(".popup__button-close"),v=document.forms.user_info,y=document.forms.user_info.user_name,h=document.forms.user_info.user_description,b=document.forms.user_info.user_submit,S=t.querySelector("#popup_img_add"),g=t.querySelector(".profile__button-add"),C=S.querySelector(".popup__button-close"),E=document.forms.place_info,L=document.forms.place_info.place_name,q=document.forms.place_info.place_link,k=document.forms.place_info.place_submit,x=t.querySelector("#popup_img_preview"),w=x.querySelector(".popup__button-close"),T=x.querySelector(".popup__image"),U=x.querySelector(".popup__item-info"),B=t.querySelector("#popup_avatar_edit"),A=t.querySelector(".profile__avatar"),P=B.querySelector(".popup__button-close"),D=document.forms.user_avatar,N=document.forms.user_avatar.avatar_link,O=document.forms.user_avatar.avatar_save;function j(e){e.classList.add("popup_opened"),document.addEventListener("keydown",G)}function J(e){e.classList.remove("popup_opened"),document.removeEventListener("keydown",G)}function M(e){e.classList.contains("popup")&&J(e)}function G(e){e.key&&"Escape"===e.key&&J(document.querySelector(".popup_opened"))}function H(e,t){e.value=t,e.dispatchEvent(new Event("input",{bobbles:!0}))}function V(e,t){t.textContent=e.value}function z(t){var n=u.querySelector("#gallery_template").content.querySelector(".gallery__item").cloneNode(!0),r=n.querySelector(".gallery__image");r.src=t.link,r.alt=t.name,r.addEventListener("click",(function(){var e,n,r,o,i;e=T,n=t.link,r=t.name,e.src=n,e.alt=r,o=U,i=t.name,o.textContent=i,j(x)})),n.querySelector(".gallery__item-name").textContent=t.name;var o=n.querySelector(".gallery__button-like"),i=n.querySelector(".gallery__like-counter");l.then((function(e){t.likes.some((function(t){return t._id==e._id}))?o.classList.add("gallery__button-like_active"):o.classList.remove("gallery__button-like_active")})).catch((function(){return console.log("Не удался запрос к информации о пользователе")})),i.textContent=t.likes.length,o.addEventListener("click",(function(){var n=o.classList.contains("gallery__button-like_active");(function(t,n){return fetch(a.baseUrl+"cards/likes/"+t,{method:n?"PUT":"DELETE",headers:a.headers}).then((function(t){return e(t)}))})(t._id,!n).then((function(e){i.textContent=String(e.likes.length),o.classList.toggle("gallery__button-like_active")})).catch((function(){return console.log("Запрос изменения состояния лайка не удался")}))}));var s=n.querySelector(".gallery__button-delete");return l.then((function(r){t.owner._id!==r._id?s.remove():s.addEventListener("click",(function(){var r;(r=t._id,fetch(a.baseUrl+c+"/"+r,{method:"DELETE",headers:a.headers}).then((function(t){return e(t)}))).then((function(){return n.remove()})).catch((function(){return console.log("Запрос удаление карточки не удался")}))}))})),n}function I(e,t){t.prepend(e)}function F(e,t){return e.querySelector(".".concat(t.name,"-error"))}function K(e,t,n,r){t.validity.patternMismatch?t.setCustomValidity(t.dataset.errorMessage):t.setCustomValidity(""),t.validity.valid?function(e,t,n,r){var o=F(e,t);t.classList.remove(n),o.classList.remove(r),o.textContent=""}(e,t,n,r):function(e,t,n,r,o){var i=F(e,t);t.classList.add(r),i.textContent=n,i.classList.add(o)}(e,t,t.validationMessage,n,r)}function Q(e,t,n){!function(e){return e.some((function(e){return!e.validity.valid}))}(e)?(t.classList.remove(n),t.removeAttribute("disabled")):(t.classList.add(n),t.setAttribute("disabled",!0))}function R(e){var t,n,r=document.querySelector(e.formSelector);t={form:r,inputs:Array.from(r.querySelectorAll(e.inputSelector)),button:r.querySelector(e.submitButtonSelector)},n={buttonClass:e.inactiveButtonClass,inputClass:e.inputErrorClass,errorClass:e.errorClass},Q(t.inputs,t.button,n.buttonClass),t.inputs.forEach((function(e){K(t.form,e,n.inputClass,n.errorClass),e.addEventListener("input",(function(){K(t.form,e,n.inputClass,n.errorClass),Q(t.inputs,t.button,n.buttonClass)}))}))}p.addEventListener("click",(function(){H(y,r.textContent),H(h,o.textContent),j(_)})),m.addEventListener("click",(function(){J(_)})),v.addEventListener("submit",(function(t){t.preventDefault(),f(b,"Сохранение..."),function(t,n){return fetch(a.baseUrl+s,{method:"PATCH",headers:a.headers,body:JSON.stringify({name:t,about:n})}).then((function(t){return e(t)}))}(y.value,h.value).then((function(){V(y,r),V(h,o),J(_)})).catch((function(){console.log("Запрос на сохранение информации о пользователе не удался")})).finally((function(){f(b,"Сохранить")}))})),_.addEventListener("mousedown",(function(e){M(e.target)})),g.addEventListener("click",(function(){H(L,""),H(q,""),j(S)})),C.addEventListener("click",(function(){J(S)})),E.addEventListener("submit",(function(t){var n,r;t.preventDefault(),f(k,"Создание..."),(n=L.value,r=q.value,fetch(a.baseUrl+c,{method:"POST",headers:a.headers,body:JSON.stringify({name:n,link:r})}).then((function(t){return e(t)}))).then((function(e){I(z(e),u),J(S)})).catch((function(){console.log("Запрос на создание карточки не удался")})).finally((function(){f(k,"Создать")}))})),S.addEventListener("mousedown",(function(e){M(e.target)})),w.addEventListener("click",(function(){J(x)})),x.addEventListener("mousedown",(function(e){M(e.target)})),A.addEventListener("click",(function(){H(N,""),j(B)})),P.addEventListener("click",(function(){J(B)})),D.addEventListener("submit",(function(t){var n;t.preventDefault(),f(O,"Сохраненине..."),(n=N.value,fetch(a.baseUrl+"users/me/avatar",{method:"PATCH",headers:a.headers,body:JSON.stringify({avatar:n})}).then((function(t){return e(t)}))).then((function(e){i.src=e.avatar,J(B)})).catch((function(){console.log("Запрос на отправку аватара пользователя не удался")})).finally((function(){f(O,"Сохранить")}))})),B.addEventListener("mousedown",(function(e){M(e.target)})),l.then((function(e){r.textContent=e.name,o.textContent=e.about,i.src=e.avatar})).catch((function(){return console.log("Запрос на получение данных о пользователе не удался")})),Promise.all([l,d]).then((function(e){e[1].reverse().forEach((function(t){t.userId=e[0]._id,I(z(t),u)}))})).catch((function(){return console.log("Запрос на получение данных о карточках не удался")})),R({formSelector:"#user_info",inputSelector:".form__input",submitButtonSelector:".popup__button-save",inactiveButtonClass:"popup__button-save_disabled",inputErrorClass:"form__input_error",errorClass:"form__input-error-msg_visible"}),R({formSelector:"#place_info",inputSelector:".form__input",submitButtonSelector:".popup__button-save",inactiveButtonClass:"popup__button-save_disabled",inputErrorClass:"form__input_error",errorClass:"form__input-error-msg_visible"}),R({formSelector:"#user_avatar",inputSelector:".form__input",submitButtonSelector:".popup__button-save",inactiveButtonClass:"popup__button-save_disabled",inputErrorClass:"form__input_error",errorClass:"form__input-error-msg_visible"})})();