(()=>{"use strict";var e=document.querySelector(".page"),t=e.querySelector(".profile"),n=t.querySelector(".profile__user-name"),o=t.querySelector(".profile__user-description"),r=t.querySelector(".profile__image"),i=e.querySelector(".gallery__items"),u="97490d78-0aeb-4bf4-9e55-1aeead76a69d",a="users/me",c="cards";function s(e,t){e.textContent=t}function l(e){return"https://nomoreparties.co/v1/plus-cohort-14/"+e}function f(){return fetch(l(a),{method:"GET",headers:{authorization:u}}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))}var d=e.querySelector("#popup_profile_edit"),p=e.querySelector(".profile__button-edit"),_=d.querySelector(".popup__button-close"),m=document.forms.user_info,v=document.forms.user_info.user_name,y=document.forms.user_info.user_description,h=document.forms.user_info.user_submit,b=e.querySelector("#popup_img_add"),S=e.querySelector(".profile__button-add"),g=b.querySelector(".popup__button-close"),C=document.forms.place_info,E=document.forms.place_info.place_name,k=document.forms.place_info.place_link,L=document.forms.place_info.place_submit,q=e.querySelector("#popup_img_preview"),j=q.querySelector(".popup__button-close"),P=q.querySelector(".popup__image"),T=q.querySelector(".popup__item-info"),x=e.querySelector("#popup_avatar_edit"),w=e.querySelector(".profile__avatar"),B=x.querySelector(".popup__button-close"),z=document.forms.user_avatar,A=document.forms.user_avatar.avatar_link,D=document.forms.user_avatar.avatar_save;function I(e){e.classList.add("popup_opened"),document.addEventListener("keydown",J)}function N(e){e.classList.remove("popup_opened"),document.removeEventListener("keydown",J)}function O(e){e.classList.contains("popup")&&N(e)}function J(e){e.key&&"Escape"===e.key&&N(document.querySelector(".popup_opened"))}function M(e,t){e.value=t,e.dispatchEvent(new Event("input",{bobbles:!0}))}function G(e,t){t.textContent=e.value}function H(e){var t=i.querySelector("#gallery_template").content.querySelector(".gallery__item").cloneNode(!0),n=t.querySelector(".gallery__image");n.src=e.link,n.alt=e.name,n.addEventListener("click",(function(){var t,n,o,r,i;t=P,n=e.link,o=e.name,t.src=n,t.alt=o,r=T,i=e.name,r.textContent=i,I(q)})),t.querySelector(".gallery__item-name").textContent=e.name;var o=t.querySelector(".gallery__button-like"),r=t.querySelector(".gallery__like-counter");e.likes.some((function(t){return t._id==e.userId}))?o.classList.add("gallery__button-like_active"):o.classList.remove("gallery__button-like_active"),r.textContent=e.likes.length,o.addEventListener("click",(function(){var t=o.classList.contains("gallery__button-like_active");(function(e,t){var n=t?"PUT":"DELETE";return fetch(l("cards/likes")+"/"+e,{method:n,headers:{authorization:u}}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))})(e._id,!t).then((function(e){r.textContent=String(e.likes.length),o.classList.toggle("gallery__button-like_active")})).catch((function(){return console.log("Запрос изменения состояния лайка не удался")}))}));var a=t.querySelector(".gallery__button-delete");return e.owner._id!==e.userId?a.remove():a.addEventListener("click",(function(){var n;(n=e._id,fetch(l(c)+"/"+n,{method:"DELETE",headers:{authorization:u}}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))).catch((function(){return console.log("Запрос удаление карточки не удался")})),t.remove()})),t}function V(e,t){t.prepend(e)}function U(e,t){return e.querySelector(".".concat(t.name,"-error"))}function F(e,t,n,o){t.validity.patternMismatch?t.setCustomValidity(t.dataset.errorMessage):t.setCustomValidity(""),t.validity.valid?function(e,t,n,o){var r=U(e,t);t.classList.remove(n),r.classList.remove(o),r.textContent=""}(e,t,n,o):function(e,t,n,o,r){var i=U(e,t);t.classList.add(o),i.textContent=n,i.classList.add(r)}(e,t,t.validationMessage,n,o)}function K(e,t,n){!function(e){return e.some((function(e){return!e.validity.valid}))}(e)?(t.classList.remove(n),t.removeAttribute("disabled")):(t.classList.add(n),t.setAttribute("disabled",!0))}function Q(e){var t,n,o=document.querySelector(e.formSelector);t={form:o,inputs:Array.from(o.querySelectorAll(e.inputSelector)),button:o.querySelector(e.submitButtonSelector)},n={buttonClass:e.inactiveButtonClass,inputClass:e.inputErrorClass,errorClass:e.errorClass},t.form.addEventListener("submit",(function(e){return e.preventDefault()})),K(t.inputs,t.button,n.buttonClass),t.inputs.forEach((function(e){F(t.form,e,n.inputClass,n.errorClass),e.addEventListener("input",(function(){F(t.form,e,n.inputClass,n.errorClass),K(t.inputs,t.button,n.buttonClass)}))}))}p.addEventListener("click",(function(){f().then((function(e){M(v,e.name),M(y,e.about),s(h,"Сохранить"),I(d)})).catch((function(){return console.log("Запрос получения информации о пользователе удался")}))})),_.addEventListener("click",(function(){N(d)})),m.addEventListener("submit",(function(e){e.preventDefault();var t="";s(h,"Сохранение..."),function(e,t){return fetch(l(a),{method:"PATCH",headers:{authorization:u,"Content-Type":"application/json"},body:JSON.stringify({name:e,about:t})}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))}(v.value,y.value).then((function(){G(v,n),G(y,o),t="Сохранено"})).catch((function(){t="Ошибка",console.log("Запрос на сохранение информации о пользователе не удался")})).finally((function(){s(h,t),N(d)}))})),d.addEventListener("mousedown",(function(e){O(e.target)})),S.addEventListener("click",(function(){M(E,""),M(k,""),s(L,"Сохранить"),I(b)})),g.addEventListener("click",(function(){N(b)})),C.addEventListener("submit",(function(e){e.preventDefault();var t,n,o="";s(L,"Сохранение..."),(t=E.value,n=k.value,fetch(l(c),{method:"POST",headers:{authorization:u,"Content-Type":"application/json"},body:JSON.stringify({name:t,link:n})}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))).then((function(e){f().then((function(t){e.userId=t._id,V(H(e),i),o="Сохранено"})).catch((function(){return console.log("Запрос получения информации о пользователе удался")}))})).catch((function(){o="Ошибка",console.log("Запрос на создание карточки не удался")})).finally((function(){s(L,o),N(b)}))})),b.addEventListener("mousedown",(function(e){O(e.target)})),j.addEventListener("click",(function(){N(q)})),q.addEventListener("mousedown",(function(e){O(e.target)})),w.addEventListener("click",(function(){f().then((function(e){M(A,e.avatar),s(D,"Сохранить"),I(x)})).catch((function(){return console.log("Запрос получения информации о пользователе удался")}))})),B.addEventListener("click",(function(){N(x)})),z.addEventListener("submit",(function(e){e.preventDefault();var t,n="";s(D,"Сохраненине..."),(t=A.value,fetch(l("users/me/avatar"),{method:"PATCH",headers:{authorization:u,"Content-Type":"application/json"},body:JSON.stringify({avatar:t})}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))).then((function(e){r.src=e.avatar,n="Сохранено"})).catch((function(){n="Ошибка",console.log("Запрос на отправку аватара пользователя не удался")})).finally((function(){s(D,n),N(x)}))})),x.addEventListener("mousedown",(function(e){O(e.target)})),f().then((function(e){n.textContent=e.name,o.textContent=e.about,r.setAttribute("src",e.avatar)})).catch((function(){return console.log("Запрос получения информации о пользователе удался")})),fetch(l(c),{method:"GET",headers:{authorization:u}}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))})).then((function(e){f().then((function(t){(e=e.reverse()).forEach((function(e){e.userId=t._id,V(H(e),i)}))})).catch((function(){return console.log("Запрос получения информации о пользователе удался")}))})).catch((function(){return console.log("Запрос получения массива карточек не удался")})),Q({formSelector:"#user_info",inputSelector:".form__input",submitButtonSelector:".popup__button-save",inactiveButtonClass:"popup__button-save_disabled",inputErrorClass:"form__input_error",errorClass:"form__input-error-msg_visible"}),Q({formSelector:"#place_info",inputSelector:".form__input",submitButtonSelector:".popup__button-save",inactiveButtonClass:"popup__button-save_disabled",inputErrorClass:"form__input_error",errorClass:"form__input-error-msg_visible"}),Q({formSelector:"#user_avatar",inputSelector:".form__input",submitButtonSelector:".popup__button-save",inactiveButtonClass:"popup__button-save_disabled",inputErrorClass:"form__input_error",errorClass:"form__input-error-msg_visible"})})();